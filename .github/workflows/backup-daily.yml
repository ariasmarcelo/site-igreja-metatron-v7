name: Backup DiÃ¡rio do Supabase

on:
  schedule:
    # Executa diariamente Ã s 3:00 AM UTC (00:00 AM BrasÃ­lia)
    - cron: '0 3 * * *'
  
  # Permite execuÃ§Ã£o manual via GitHub Actions UI
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Buscar todo o histÃ³rico para branches
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: ğŸ“š Instalar dependÃªncias
        run: |
          cd workspace/shadcn-ui
          pnpm install --frozen-lockfile
      
      - name: âš™ï¸ Configurar variÃ¡veis de ambiente
        run: |
          cd workspace/shadcn-ui
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> .env.local
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> .env.local
      
      - name: ğŸ—„ï¸ Executar backup
        run: |
          cd workspace/shadcn-ui
          node scripts/backup-and-commit.js --verbose
        continue-on-error: false
      
      - name: ğŸ“Š Verificar tamanho do backup
        run: |
          cd workspace/shadcn-ui
          echo "ğŸ“¦ Tamanho total dos backups:"
          du -sh backups/ || echo "Nenhum backup encontrado"
      
      - name: ğŸ‰ Resumo
        if: success()
        run: |
          echo "âœ… Backup concluÃ­do com sucesso!"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸŒ¿ Branch: backups/database"
          echo "ğŸ“ Para visualizar: git checkout backups/database"
      
      - name: âš ï¸ Notificar falha
        if: failure()
        run: |
          echo "âŒ Backup falhou!"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ” Verifique os logs acima para detalhes"
